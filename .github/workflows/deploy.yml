name: CI/CD to AWS EC2

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DB_URL: ${{ secrets.DB_URL }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: |
          set -euxo pipefail
          pwd
          ls -al
          ls -al gradlew
          ls -al build.gradle* || true
          ./gradlew --version
          ./gradlew clean bootJar -x test --stacktrace --info


      - name: Inspect outputs
        run: |
          echo "=== jars (all) ==="
          find . -type f -name "*.jar" -print
          echo "=== wars (all) ==="
          find . -type f -name "*.war" -print
          echo "=== build/libs dirs ==="
          find . -type d -path "*/build/libs" -print


      - name: Upload build artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: "**/build/libs/*.jar"
          if-no-files-found: error
          retention-days: 1


  deploy:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          
      - name: Inspect downloaded artifact
        run: |
          pwd
          ls -al
          echo "=== find jars ==="
          find . -maxdepth 5 -type f -name "*.jar" -print

      - name: Debug what will be packed
        run: |
          echo "PWD=$(pwd)"
          echo "=== list ==="
          ls -al
          echo "=== jars ==="
          find . -type f -name "*.jar" -print
          echo "=== size (top 30) ==="
          du -ah . | sort -hr | head -n 30
          echo "=== does build/libs exist? ==="
          ls -al build || true
          ls -al build/libs || true


      - name: Deploy to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.EC2_USERNAME }}/app"

      - name: Execute deployment script on EC2
        uses: appleboy/ssh-action@master
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          S3_REGION: ${{ secrets.S3_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: >-
            DB_HOST,DB_PORT,DB_NAME,DB_USERNAME,DB_PASSWORD,
            S3_REGION,S3_BUCKET_NAME,
            AWS_ACCESS_KEY,AWS_SECRET_ACCESS_KEY
          script: |
            #!/bin/bash

            cd /home/${{ secrets.EC2_USERNAME }}/app
            JAR_FILE=$(ls -t *.jar | head -n 1)

            sudo tee /etc/systemd/system/homepage.service > /dev/null <<EOF
            [Unit]
            Description=Homepage Application
            After=network.target

            [Service]
            Type=simple
            User=${{ secrets.EC2_USERNAME }}
            WorkingDirectory=/home/${{ secrets.EC2_USERNAME }}/app
            ExecStart=/usr/bin/java -jar /home/${{ secrets.EC2_USERNAME }}/app/$JAR_FILE
            Environment="SPRING_PROFILES_ACTIVE=prod"
            Environment="DB_HOST=$DB_HOST"
            Environment="DB_PORT=$DB_PORT"
            Environment="DB_NAME=$DB_NAME"
            Environment="DB_USERNAME=$DB_USERNAME"
            Environment="DB_PASSWORD=$DB_PASSWORD"
            Environment="S3_REGION=$S3_REGION"
            Environment="S3_BUCKET_NAME=$S3_BUCKET_NAME"
            Environment="AWS_ACCESS_KEY=$AWS_ACCESS_KEY"
            Environment="AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
            Restart=always
            RestartSec=10
            StandardOutput=append:/home/${{ secrets.EC2_USERNAME }}/app/logs/application.log
            StandardError=append:/home/${{ secrets.EC2_USERNAME }}/app/logs/error.log

            [Install]
            WantedBy=multi-user.target
            EOF

            mkdir -p /home/${{ secrets.EC2_USERNAME }}/app/logs

            sudo systemctl daemon-reload
            sudo systemctl enable homepage
            sudo systemctl restart homepage

            sleep 5
            sudo systemctl status homepage --no-pager

            echo "===== Checking application startup ====="
            tail -n 50 /home/${{ secrets.EC2_USERNAME }}/app/logs/application.log
